#!/bin/sh
# jenkins-run.sh - starts or restarts an api with docker
# usually called remotely by jenkins

# usage: start-container.sh API-NAME

set -eu

api_name=${1:-}
if [ -z "$api_name" ]; then
    echo 2>&1 "usage: jenkins-run.sh API-NAME"
    exit 1
fi
if [ "$(echo $api_name | tr -d "A-Za-z0-9-_")" ]; then
    echo 2>&1 "invalid api name: $api_name"
    exit 1
fi
if [ ! -d /apis/apis/"$api_name" ]; then
    echo 2>&1 "api does not exist: $api_name"
    exit 1
fi

api_path=/apis/apis/$api_name
cd $api_path &&

archive=$(ls "$api_name"-*-all.jar | sort | tail -1)
config=/apis/config/$api_name.yaml
env=/apis/env/$api_name.env
keytool_path=/apis/keytool_files

if [ ! -e "$config" ]; then
    config=/apis/apis/$api_name/configuration.yaml
fi

uid="$(id -u {{ api_user }})"
gid="$(id -g {{ api_user }})"

# Stop and destroy container if it's already running
if [[ "$(docker ps -aq -f name=$api_name)" ]]; then
    echo "Stop existing container"
    docker stop "$api_name"
    docker rm "$api_name"

    # Sometimes docker will still think a container exists after doing "docker rm"
    # Pause the script for a few seconds before creating the container again
    until [[ ! "$(docker ps -aq -f name=$api_name)" ]]; do
        sleep 1
    done
fi

echo "Start container"

java_command="java -Xmx100m -jar $archive server $config"

docker run \
    -d \
    --name "$api_name" \
    --label jar=$archive \
    --restart on-failure:3 \
    --user="$uid:$gid" \
    --workdir="$api_path" \
    --env-file "$env" \
    --network host \
    --health-cmd='curl -k -fsS https://localhost:$ADMIN_PORT/healthcheck' \
    --health-interval={{ container_health_interval_seconds }}s \
    --health-timeout {{ container_health_timeout_seconds }}s \
    --volume $keytool_path/server.keystore:$keytool_path/server.keystore:ro \
    --volume $keytool_path/server.truststore:$keytool_path/server.truststore:ro \
    --volume $api_path:$api_path \
    --volume $config:$config:ro \
    {{ dropwizard_docker_image }} \
    /bin/bash -c "$java_command"

if [[ ! $(docker ps -q -f name=$api_name) ]]; then
    echo "ERROR: Container not running"
    exit 1
fi

{% include 'timeout-delay.sh.j2' %}
